<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StaticQuasar931 — Favicon Vote (A vs B)</title>
<style>
  :root{
    --bg:#0f1216;--ink:#e6edf3;--muted:#9fb0c3;
    --blue1:#3b82f6; --blue2:#60a5fa;
    --glass: rgba(255,255,255,.06);
    --line: rgba(255,255,255,.10);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html{background:var(--bg);color:var(--ink)}
  body{margin:0;display:grid;place-items:center;padding:16px}

  .card{
    width:min(1100px,98vw);
    border-radius:16px;
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 10px 40px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.06);
    padding:16px; margin:0;
    display:grid; grid-template-rows:auto auto 1fr; gap:14px;
  }

  /* 1) Title and short helper text */
  .title{margin:0;font-size:clamp(28px,4.2vw,40px);font-weight:1000;line-height:1.12}
  .subtitle{
    margin:4px 0 0 0;font-size:clamp(14px,1.8vw,16px);color:var(--muted);
    font-weight:700;letter-spacing:.2px
  }
  .subtitle b{color:#d7e6f8}

  /* 2) The comparison image goes FULL WIDTH directly under the prompt */
  .imgStrip{
    border-radius:12px;
    border:1px solid var(--line);
    background:#0c1116;
    overflow:hidden;
  }
  /* Keep it crisp and remove extra gaps so there is no wasted space */
  .imgStrip img{
    display:block;
    width:100%;
    height:auto;         /* honors the short 112px height naturally */
    image-rendering:auto;
  }
  .imgActions{
    display:flex;justify-content:flex-end;gap:8px;padding:8px 10px 0 10px
  }
  .open-btn{
    padding:6px 10px;font-size:12px;font-weight:800;border-radius:10px;
    border:1px solid rgba(255,255,255,.32);
    background:rgba(6,12,18,.55);color:#e9f2ff;backdrop-filter:blur(6px);cursor:pointer
  }

  /* 3) Results and voting */
  .bottom{
    display:flex;flex-direction:column;gap:12px;border-radius:12px;
    padding:14px;background:rgba(255,255,255,.03);outline:1px solid rgba(255,255,255,.06);min-height:0
  }
  .t-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .t-title{font-size:14px;color:#cfe1ff;font-weight:800;letter-spacing:.2px}
  .t-numbers{font-size:13px;color:var(--muted)}

  .bars{display:grid;grid-template-columns:1fr;gap:12px;margin-top:4px}
  .bar-row{display:grid;grid-template-columns:36px 1fr 52px;align-items:center;gap:10px}
  .label{width:36px;text-align:right;font-weight:1000;font-size:16px}
  .bar{position:relative;height:38px;border-radius:999px;background:var(--glass);overflow:hidden;outline:1px solid var(--line)}
  .fill{position:absolute;inset:0 100% 0 0;transition:inset .28s cubic-bezier(.22,.61,.36,1)}
  .fillA{background:linear-gradient(90deg,#ffffff,#e5f0ff)}
  .fillB{background:linear-gradient(90deg,var(--blue1),var(--blue2))}
  .pct{min-width:52px;text-align:left;font-variant-numeric:tabular-nums;font-weight:1000}

  .msg{padding:10px 12px;border-radius:10px;font-size:14px;display:none}
  .ok{background:rgba(45,108,223,.14);border:1px solid rgba(45,108,223,.35)}
  .warn{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.35)}

  .row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .vote{
    border:0;border-radius:14px;padding:12px 10px;font-weight:1000;font-size:18px;cursor:pointer;
    transition:transform .08s ease,filter .18s ease;box-shadow:inset 0 -2px 0 rgba(0,0,0,.2);
    display:flex;align-items:center;justify-content:center;gap:10px
  }
  .vote:hover{transform:translateY(-2px);filter:brightness(1.08)}
  .btnA{background:#fff;color:#081018}
  .btnB{background:linear-gradient(90deg,var(--blue1),var(--blue2));color:#f1f7ff}

  .icon{
    width:28px;height:28px;border-radius:6px;object-fit:cover;background:#0b0f14;
    box-shadow:0 1px 0 rgba(255,255,255,.6) inset, 0 0 0 1px rgba(0,0,0,.35) inset
  }

  @media(max-width:840px){
    .row{grid-template-columns:1fr}
    .bar{height:34px}
  }
</style>
</head>
<body>
<div class="card" role="region" aria-labelledby="title">
  <!-- 1) Clear and simple prompt -->
  <header>
    <h1 id="title" class="title">Which favicon looks better: A or B?</h1>
    <p class="subtitle">
      A favicon is the tiny site icon you see in your browser tab and bookmarks. Please pick that you prefer.
    </p>
  </header>

  <!-- 2) The comparison image is now full width directly under the prompt -->
  <section class="imgStrip" aria-label="Favicon comparison preview">
    <div class="imgActions">
      <button id="openFull" class="open-btn" type="button">Open full image</button>
    </div>
    <img id="preview"
      src="https://res.cloudinary.com/dcsrqennd/image/upload/v1759186607/Screenshot_2025-09-29_at_15-56-44_Images_StaticQuasar931_-_Google_Slides_vlthih.png"
      alt="Side by side browser tabs showing favicon A and favicon B" loading="eager" decoding="async"/>
  </section>

  <!-- 3) Live results and voting -->
  <section class="bottom" aria-live="polite">
    <div class="t-head">
      <div class="t-title">Current rating</div>
      <div id="totals" class="t-numbers">—</div>
    </div>

    <div class="bars">
      <div class="bar-row"><div class="label">A</div><div class="bar"><div id="fillA" class="fill fillA"></div></div><div id="pA" class="pct">—</div></div>
      <div class="bar-row"><div class="label">B</div><div class="bar"><div id="fillB" class="fill fillB"></div></div><div id="pB" class="pct">—</div></div>
    </div>

    <div id="msg" class="msg ok" role="status" aria-live="polite"></div>

    <div class="row" aria-label="Vote on favicon">
      <button id="btnA" class="vote btnA" type="button">
        <img class="icon" alt="A icon" src="https://res.cloudinary.com/dcsrqennd/image/upload/v1754794352/607b720a5748a2ae22b9c2ebc44eb23130e0b023_uendui.jpg"/>
        Vote A
      </button>
      <button id="btnB" class="vote btnB" type="button">
        <img class="icon" alt="B icon" src="https://res.cloudinary.com/dcsrqennd/image/upload/v1759702515/unnamed_1_iyooek.jpg"/>
        Vote B
      </button>
    </div>
  </section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, doc, runTransaction, increment, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  /* ---------- Firebase ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyCFkdHG5na9uhLQwu65QTuOvELmA68MCKA",
    authDomain: "votingonredesign.firebaseapp.com",
    projectId: "votingonredesign",
    storageBucket: "votingonredesign.firebasestorage.app",
    messagingSenderId: "66146609429",
    appId: "1:66146609429:web:34575c54f0a3b78ce7611c",
    measurementId: "G-FL6RJVCN3Y"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ---------- Poll namespace (same as prior step) ---------- */
  const POLL_COLLECTION = "polls_favicon_live";
  const POLL_ID         = "favicon_pick_v1";
  const POLL_SLUG       = "favicon_pick_v1";

  /* ---------- Local device id + keys ---------- */
  const DEVICE_KEY  = "qr_device_id";
  const PENDING_KEY = `qr_pending_${POLL_SLUG}`;
  const LOCK_KEY    = `qr_lock_${POLL_SLUG}`;

  const uuid = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
  const deviceId = (() => {
    let id = localStorage.getItem(DEVICE_KEY);
    if (!id){ id = uuid(); localStorage.setItem(DEVICE_KEY,id); }
    return id;
  })();

  /* ---------- DOM ---------- */
  const fullUrl = "https://res.cloudinary.com/dcsrqennd/image/upload/v1759186607/Screenshot_2025-09-29_at_15-56-44_Images_StaticQuasar931_-_Google_Slides_vlthih.png";
  document.getElementById("openFull").addEventListener("click", () => window.open(fullUrl, "_blank", "noopener"));
  document.getElementById("preview").addEventListener("click",   () => window.open(fullUrl, "_blank", "noopener"));

  const btns = {
    A: document.getElementById("btnA"),
    B: document.getElementById("btnB")
  };
  const fills = {
    A: document.getElementById("fillA"),
    B: document.getElementById("fillB")
  };
  const pctEls = {
    A: document.getElementById("pA"),
    B: document.getElementById("pB")
  };
  const totalsEl = document.getElementById("totals");
  const msg = document.getElementById("msg");
  const showOk   = (t) => { msg.className="msg ok";   msg.style.display="block"; msg.textContent=t; };
  const showWarn = (t) => { msg.className="msg warn"; msg.style.display="block"; msg.textContent=t; };
  const disableButtons = () => Object.values(btns).forEach(b => { b.disabled = true;  b.style.opacity=".7"; });
  const enableButtons  = () => Object.values(btns).forEach(b => { b.disabled = false; b.style.opacity="1";  });

  /* ---------- Firestore refs ---------- */
  const tallyDoc = doc(db, POLL_COLLECTION, POLL_ID);
  const voteDoc  = (id) => doc(db, POLL_COLLECTION, POLL_ID, "votes", id);

  /* ---------- Ensure tally exists with A/B = 0 ---------- */
  (async () => {
    const snap = await getDoc(tallyDoc);
    if (!snap.exists()) {
      await setDoc(tallyDoc, { A:0, B:0 });
    }
  })().catch(e => console.error("Init tally error:", e));

  /* ---------- Live results ---------- */
  onSnapshot(tallyDoc, (snap) => {
    const d = snap.data() || { A:0,B:0 };
    const A = d.A|0, B = d.B|0;
    const total = Math.max(0, A+B);
    const pct = (x) => total ? Math.round((x/total)*100) : 0;
    const a=pct(A), b=pct(B);

    totalsEl.textContent = total ? `A ${a}% · B ${b}%` : "No votes yet";

    const setFill = (el, v) => el.style.inset = `0 ${100-v}% 0 0`;
    setFill(fills.A, a); setFill(fills.B, b);
    pctEls.A.textContent = total ? a+"%" : "—";
    pctEls.B.textContent = total ? b+"%" : "—";
  }, (e) => {
    console.error("Snapshot error:", e);
    totalsEl.textContent = "Live results unavailable";
  });

  /* ---------- Respect local lock ---------- */
  const lockChoice = localStorage.getItem(LOCK_KEY);
  if (lockChoice){ disableButtons(); showOk(`You already voted "${lockChoice}".`); }

  /* ---------- Resume pending upload ---------- */
  const pending = localStorage.getItem(PENDING_KEY);
  if (!lockChoice && pending){
    const { choice } = JSON.parse(pending);
    finalizeUpload(choice).then(()=>{
      localStorage.setItem(LOCK_KEY, choice);
      localStorage.removeItem(PENDING_KEY);
      disableButtons(); showOk(`Thanks. Your "${choice}" vote was recorded.`);
    }).catch((e)=>{
      console.error("Resume failed:", e);
      showWarn("Could not finish uploading your saved vote. Fix rules or network, then try again.");
      enableButtons();
    });
  }

  /* ---------- Click handlers ---------- */
  Object.entries(btns).forEach(([choice, btn]) => {
    btn.addEventListener("click", () => handleVote(choice));
  });

  async function handleVote(choice){
    if (localStorage.getItem(LOCK_KEY)) return;
    localStorage.setItem(PENDING_KEY, JSON.stringify({ choice, at: Date.now() }));
    showOk("Saving your choice...");
    disableButtons();

    try {
      await finalizeUpload(choice);
      localStorage.setItem(LOCK_KEY, choice);
      localStorage.removeItem(PENDING_KEY);
      disableButtons(); showOk(`Thanks. Your "${choice}" vote was recorded.`);
    } catch (e){
      console.error("Vote upload failed:", e);
      if (e?.code === "permission-denied") {
        showWarn("Vote failed. Publish the Firestore rules for polls_favicon_live, then retry.");
      } else {
        showWarn("Network or server issue - your vote is saved locally and will retry next visit.");
      }
      enableButtons();
    }
  }

  /* ---------- Transaction: create vote subdoc + increment exactly one counter ---------- */
  async function finalizeUpload(choice){
    const vDoc = voteDoc(deviceId);
    await runTransaction(db, async (tx) => {
      tx.set(vDoc, { choice, deviceId, votedAt: new Date().toISOString() });
      tx.update(tallyDoc, { [choice]: increment(1) });
    });
  }

  /* ---------- Leave guard ---------- */
  window.onbeforeunload = function(){
    if (!localStorage.getItem(LOCK_KEY) && localStorage.getItem(PENDING_KEY)){
      return "Your vote is saved locally and uploading. Leave now?";
    }
  };
</script>
</body>
</html>

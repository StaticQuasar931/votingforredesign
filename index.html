<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StaticQuasar931 ‚Äî Banner Vote (A/B/C/D)</title>
<style>
  :root{
    --bg:#0f1216;--ink:#e6edf3;--muted:#9fb0c3;
    --blue1:#3b82f6; --blue2:#60a5fa;
    --green1:#16a34a; --green2:#22c55e;
    --red1:#ef4444; --red2:#7f1d1d;
  }
  *{box-sizing:border-box}
  html,body{height:100%;overflow:hidden}
  html{background:var(--bg);color:var(--ink)}
  body{margin:0;display:grid;place-items:center}

  .card{
    width:min(1200px,96vw);
    height:min(96vh,900px);
    border-radius:16px;
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 10px 40px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.06);
    padding:14px; margin:12px;
    display:grid; grid-template-rows:1fr 1fr; gap:14px; min-height:0;
  }

  /* TOP HALF = two quarters: text (left), image (right) */
  .top{display:grid;grid-template-columns:1fr 1fr;gap:14px;min-height:0}
  .info{display:flex;flex-direction:column;gap:10px;min-width:0;min-height:0}
  .title{margin:0;font-size:clamp(34px,4vw,44px);font-weight:1000;line-height:1.04;letter-spacing:.2px}
  .info-shell{flex:1 1 auto;min-height:0;display:flex}
  .info-text{
    flex:1 1 auto;height:100%;
    display:flex;flex-direction:column;gap:10px;justify-content:flex-start;
    font-size:clamp(20px,2.6vw,30px);font-weight:900;line-height:1.28;
    background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
    padding:22px;border-radius:12px;outline:1px solid rgba(255,255,255,.08);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.08)
  }
  .info-text small{display:block;color:#c9d7e6;font-weight:700}
  .info-text a{color:#b2d1ff;font-weight:1000;text-underline-offset:3px}

  .imgBox{
    position:relative;width:100%;height:100%; /* FILL the whole top-right quarter */
    border-radius:12px;border:1px solid rgba(255,255,255,.08);
    box-shadow:0 10px 40px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.06);
    background:
      radial-gradient(120% 70% at 50% 0%, rgba(99,102,241,.16), transparent 60%),
      #0c1116;
    padding:1px; /* image is ~2px narrower than outer shadowed box */
    overflow:hidden;display:grid;place-items:center;min-height:140px;
  }
  .imgBox img{max-width:100%;max-height:100%;width:auto;height:auto;object-fit:contain;display:block}
  .open-btn{
    position:absolute;top:10px;right:10px;padding:6px 10px;font-size:12px;font-weight:800;
    border-radius:10px;border:1px solid rgba(255,255,255,.32);
    background:rgba(6,12,18,.55);color:#e9f2ff;backdrop-filter:blur(6px);cursor:pointer
  }

  /* BOTTOM HALF = results + vote buttons */
  .bottom{display:flex;flex-direction:column;gap:12px;border-radius:12px;padding:16px;background:rgba(255,255,255,.03);outline:1px solid rgba(255,255,255,.06);min-height:0}
  .t-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .t-title{font-size:14px;color:#cfe1ff;font-weight:800;letter-spacing:.2px}
  .t-numbers{font-size:13px;color:var(--muted)}

  .bars{display:grid;grid-template-columns:1fr;gap:14px;margin-top:8px;flex:1 1 auto;min-height:0}
  .bar-row{display:grid;grid-template-columns:40px 1fr 64px;align-items:center;gap:10px}
  .label{width:40px;text-align:right;font-weight:1000;font-size:16px}
  .bar{position:relative;height:48px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;outline:1px solid rgba(255,255,255,.08)}
  .fill{position:absolute;inset:0 100% 0 0;transition:inset .28s cubic-bezier(.22,.61,.36,1)}
  .fillA{background:linear-gradient(90deg,#ffffff,#e5f0ff)}
  .fillB{background:linear-gradient(90deg,var(--blue1),var(--blue2))}
  .fillC{background:linear-gradient(90deg,var(--green1),var(--green2))}
  .fillD{background:linear-gradient(90deg,var(--red1),var(--red2))}
  .pct{min-width:64px;text-align:left;font-variant-numeric:tabular-nums;font-weight:1000}

  .msg{padding:10px 12px;border-radius:10px;font-size:14px;display:none}
  .ok{background:rgba(45,108,223,.14);border:1px solid rgba(45,108,223,.35)}
  .warn{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.35)}

  .row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .vote{border:0;border-radius:14px;padding:14px 10px;font-weight:1000;font-size:16px;cursor:pointer;transition:transform .08s ease,filter .18s ease;box-shadow:inset 0 -2px 0 rgba(0,0,0,.2)}
  .vote:hover{transform:translateY(-2px);filter:brightness(1.08)}
  .btnA{background:#fff;color:#081018}
  .btnB{background:linear-gradient(90deg,var(--blue1),var(--blue2));color:#f1f7ff}
  .btnC{background:linear-gradient(90deg,var(--green1),var(--green2));color:#041307}
  .btnD{background:linear-gradient(90deg,var(--red1),var(--red2));color:#fff}

  @media(max-width:900px){
    .top{grid-template-columns:1fr}
    .imgBox{height:220px}
    .row{grid-template-columns:1fr 1fr}
    .bar{height:40px}
  }
</style>
</head>
<body>
<div class="card" role="region" aria-labelledby="title">

  <!-- TOP HALF -->
  <div class="top">
    <section class="info">
      <h1 id="title" class="title">Which banner should we use? Vote for A, B, C, or D.</h1>
      <div class="info-shell">
        <div class="info-text">
          Help pick StaticQuasar931‚Äôs new banner:
          <small>
            This is going to be update #2 to our redesign, fill out our
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSfWkJmq5rk10-AETybm7hJPQ2M75gMGm2OWsbiS_XrqMI9l0g/viewform?usp=header" target="_blank" rel="noopener">Google Form</a>
            for more detailed suggestions (What should we update next?)
          </small>
          <small>
            The best suggestion/most helped person gets a shout out!
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSfWkJmq5rk10-AETybm7hJPQ2M75gMGm2OWsbiS_XrqMI9l0g/viewform?usp=header" target="_blank" rel="noopener">Give us Ideas now</a>.
          </small>
        </div>
      </div>
    </section>

    <!-- IMAGE fills whole top-right quarter, image is ~2px narrower than the shadow box -->
    <aside class="imgBox" aria-label="Banner preview">
      <button id="openFull" class="open-btn" type="button">üîç View Full</button>
      <img id="preview"
        src="https://res.cloudinary.com/dcsrqennd/image/upload/v1759184767/Redesign_Banner_Vote_hf8jn7.png"
        alt="Preview of four banner choices labelled A, B, C, D" loading="eager" decoding="async"/>
    </aside>
  </div>

  <!-- BOTTOM HALF -->
  <section class="bottom" aria-live="polite">
    <div class="t-head">
      <div class="t-title">Current rating</div>
      <div id="totals" class="t-numbers">‚Äî</div>
    </div>

    <div class="bars">
      <div class="bar-row"><div class="label">A</div><div class="bar"><div id="fillA" class="fill fillA"></div></div><div id="pA" class="pct">‚Äî</div></div>
      <div class="bar-row"><div class="label">B</div><div class="bar"><div id="fillB" class="fill fillB"></div></div><div id="pB" class="pct">‚Äî</div></div>
      <div class="bar-row"><div class="label">C</div><div class="bar"><div id="fillC" class="fill fillC"></div></div><div id="pC" class="pct">‚Äî</div></div>
      <div class="bar-row"><div class="label">D</div><div class="bar"><div id="fillD" class="fill fillD"></div></div><div id="pD" class="pct">‚Äî</div></div>
    </div>

    <div id="msg" class="msg ok" role="status" aria-live="polite"></div>

    <div class="row" aria-label="Vote on banner">
      <button id="btnA" class="vote btnA" type="button">üÖ∞Ô∏è Vote A</button>
      <button id="btnB" class="vote btnB" type="button">üÖ±Ô∏è Vote B</button>
      <button id="btnC" class="vote btnC" type="button">üá® Vote C</button>
      <button id="btnD" class="vote btnD" type="button">üá© Vote D</button>
    </div>
  </section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, doc, runTransaction, increment, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  /* ---------- Firebase (match your project) ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyCFkdHG5na9uhLQwu65QTuOvELmA68MCKA",
    authDomain: "votingonredesign.firebaseapp.com",
    projectId: "votingonredesign",
    storageBucket: "votingonredesign.firebasestorage.app",
    messagingSenderId: "66146609429",
    appId: "1:66146609429:web:34575c54f0a3b78ce7611c",
    measurementId: "G-FL6RJVCN3Y"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ---------- NEW section/collection & local phrase (aligns with the rules you published) ---------- */
  const POLL_COLLECTION = "polls_banner_live";   // must match rules block
  const POLL_ID         = "banner_pick_prod_v2"; // doc id (safe to change to reset server-side tally)
  const POLL_SLUG       = "banner_pick_prod_v2"; // client-side namespace (change to reset local locks)

  /* ---------- Local device id (reused across polls) + per-poll keys ---------- */
  const DEVICE_KEY  = "qr_device_id";
  const PENDING_KEY = `qr_pending_${POLL_SLUG}`;
  const LOCK_KEY    = `qr_lock_${POLL_SLUG}`;

  const uuid = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
  const deviceId = (() => {
    let id = localStorage.getItem(DEVICE_KEY);
    if (!id){ id = uuid(); localStorage.setItem(DEVICE_KEY,id); }
    return id;
  })();

  /* ---------- DOM ---------- */
  const fullUrl = "https://res.cloudinary.com/dcsrqennd/image/upload/v1759184767/Redesign_Banner_Vote_hf8jn7.png";
  document.getElementById("openFull").addEventListener("click", () => window.open(fullUrl, "_blank", "noopener"));
  document.getElementById("preview").addEventListener("click",   () => window.open(fullUrl, "_blank", "noopener"));

  const btns = {
    A: document.getElementById("btnA"),
    B: document.getElementById("btnB"),
    C: document.getElementById("btnC"),
    D: document.getElementById("btnD")
  };
  const fills = {
    A: document.getElementById("fillA"),
    B: document.getElementById("fillB"),
    C: document.getElementById("fillC"),
    D: document.getElementById("fillD")
  };
  const pctEls = {
    A: document.getElementById("pA"),
    B: document.getElementById("pB"),
    C: document.getElementById("pC"),
    D: document.getElementById("pD")
  };
  const totalsEl = document.getElementById("totals");
  const msg = document.getElementById("msg");
  const showOk   = (t) => { msg.className="msg ok";   msg.style.display="block"; msg.textContent=t; };
  const showWarn = (t) => { msg.className="msg warn"; msg.style.display="block"; msg.textContent=t; };
  const disableButtons = () => Object.values(btns).forEach(b => { b.disabled = true;  b.style.opacity=".7"; });
  const enableButtons  = () => Object.values(btns).forEach(b => { b.disabled = false; b.style.opacity="1";  });

  /* ---------- Firestore refs (MUST match rules) ---------- */
  const tallyDoc = doc(db, POLL_COLLECTION, POLL_ID);
  const voteDoc  = (id) => doc(db, POLL_COLLECTION, POLL_ID, "votes", id);

  /* ---------- Ensure tally exists with A/B/C/D = 0 ---------- */
  (async () => {
    const snap = await getDoc(tallyDoc);
    if (!snap.exists()) {
      await setDoc(tallyDoc, { A:0, B:0, C:0, D:0 }); // allowed by "create" rule
    }
  })().catch(e => console.error("Init tally error:", e));

  /* ---------- Live results ---------- */
  onSnapshot(tallyDoc, (snap) => {
    const d = snap.data() || { A:0,B:0,C:0,D:0 };
    const A = d.A|0, B = d.B|0, C = d.C|0, D = d.D|0;
    const total = Math.max(0, A+B+C+D);
    const pct = (x) => total ? Math.round((x/total)*100) : 0;
    const a=pct(A), b=pct(B), c=pct(C), d_=pct(D);

totalsEl.textContent = total
  ? `A ${a}% ¬∑ B ${b}% ¬∑ C ${c}% ¬∑ D ${d_}%`
  : "No votes yet";


    const setFill = (el, v) => el.style.inset = `0 ${100-v}% 0 0`;
    setFill(fills.A, a); setFill(fills.B, b); setFill(fills.C, c); setFill(fills.D, d_);
    pctEls.A.textContent = total ? a+"%" : "‚Äî";
    pctEls.B.textContent = total ? b+"%" : "‚Äî";
    pctEls.C.textContent = total ? c+"%" : "‚Äî";
    pctEls.D.textContent = total ? d_+"%" : "‚Äî";
  }, (e) => {
    console.error("Snapshot error:", e);
    totalsEl.textContent = "Live results unavailable";
  });

  /* ---------- Respect THIS poll‚Äôs local lock only ---------- */
  const lockChoice = localStorage.getItem(LOCK_KEY);
  if (lockChoice){ disableButtons(); showOk(`You already voted ‚Äú${lockChoice}‚Äù.`); }

  /* ---------- Resume pending upload (if any) ---------- */
  const pending = localStorage.getItem(PENDING_KEY);
  if (!lockChoice && pending){
    const { choice } = JSON.parse(pending);
    finalizeUpload(choice).then(()=>{
      localStorage.setItem(LOCK_KEY, choice);
      localStorage.removeItem(PENDING_KEY);
      disableButtons(); showOk(`Thanks! Your ‚Äú${choice}‚Äù vote was recorded.`);
    }).catch((e)=>{
      console.error("Resume failed:", e);
      showWarn("Couldn't finish uploading your saved vote. Fix rules/network, then try again.");
      enableButtons();
    });
  }

  /* ---------- Click handlers ---------- */
  Object.entries(btns).forEach(([choice, btn]) => {
    btn.addEventListener("click", () => handleVote(choice));
  });

  async function handleVote(choice){
    if (localStorage.getItem(LOCK_KEY)) return;
    localStorage.setItem(PENDING_KEY, JSON.stringify({ choice, at: Date.now() }));
    showOk("Saving your choice‚Ä¶");
    disableButtons();

    try {
      await finalizeUpload(choice);
      localStorage.setItem(LOCK_KEY, choice);
      localStorage.removeItem(PENDING_KEY);
      disableButtons(); showOk(`Thanks! Your ‚Äú${choice}‚Äù vote was recorded.`);
    } catch (e){
      console.error("Vote upload failed:", e);
      // DO NOT lock on permission errors ‚Äî this keeps the UI retryable
      if (e?.code === "permission-denied") {
        showWarn("Vote failed: Firestore rules for polls_banner_live aren‚Äôt published or conflict with the update. Publish the rules I sent (unchanged), then try again.");
      } else {
        showWarn("Network/server issue ‚Äî your vote is saved locally and will retry next visit.");
      }
      enableButtons();
    }
  }

  /* ---------- Transaction: create vote subdoc + increment exactly one counter ---------- */
  async function finalizeUpload(choice){
    const vDoc = voteDoc(deviceId);
    await runTransaction(db, async (tx) => {
      // IMPORTANT: do NOT tx.get(vDoc) ‚Äî reads are denied by rules; just set.
      tx.set(vDoc, { choice, deviceId, votedAt: new Date().toISOString() });
      // This matches the rules: only A/B/C/D exist and exactly one increments by 1.
      tx.update(tallyDoc, { [choice]: increment(1) });
    });
  }

  /* ---------- Leave guard if a vote is pending ---------- */
  window.onbeforeunload = function(){
    if (!localStorage.getItem(LOCK_KEY) && localStorage.getItem(PENDING_KEY)){
      return "Your vote is saved locally and uploading. Leave now?";
    }
  };
</script>
</body>
</html>

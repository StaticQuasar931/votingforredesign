<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quick Vote ‚Äì Theme Switch</title>
<style>
  :root{
    --bg:#0f1216;--card:#141a21;--ink:#e6edf3;--muted:#9fb0c3;
    --yes:#22c55e;--no:#ef4444;--ring:#2d6cdf;
    --blue1:#3b82f6; --blue2:#60a5fa;
    --vio1:#6366f1;  --vio2:#8b5cf6;
  }

  /* Disable scrolling both directions */
  html, body { height:100%; overflow:hidden; }
  html { background:var(--bg); color:var(--ink); }
  body{
    margin:0;
    display:grid; place-items:center;
  }

  .card{
    width:min(1200px,96vw);
    border-radius:16px;
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 10px 40px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.06);
    padding:14px;
    margin:12px; /* inner gutter so no scrollbars */
  }

  .layout{
    display:grid;
    grid-template-columns: 1.05fr 1fr;
    gap:14px;
    align-items:stretch;
    min-height:460px;
  }

  /* LEFT */
  .left{display:flex; flex-direction:column; gap:12px; min-width:0; min-height:0;}
  .title{margin:0; font-size:clamp(20px,2.2vw,26px); font-weight:900; line-height:1.2;}
  .sub{color:var(--muted); margin:0; font-size:13px}

  .tally{
    border-radius:10px; padding:12px;
    background:rgba(255,255,255,.03); outline:1px solid rgba(255,255,255,.06);
  }
  .t-head{display:flex; justify-content:space-between; align-items:center; gap:10px}
  .t-title{font-size:14px; color:#cfe1ff; font-weight:800; letter-spacing:.2px}
  .t-numbers{font-size:13px; color:var(--muted)}
  .bar{margin-top:10px; height:14px; border-radius:999px; background:rgba(255,255,255,.06); position:relative; overflow:hidden}
  .bar-yes,.bar-no{position:absolute; top:0; bottom:0; transition:width .28s cubic-bezier(.22,.61,.36,1)}
  .bar-yes{left:0; background:linear-gradient(90deg,#16a34a,var(--yes))}
  .bar-no{right:0; background:linear-gradient(90deg,var(--no),#7f1d1d)}
  .labels{display:flex; justify-content:space-between; margin-top:6px; font-size:12px; color:var(--muted)}
  .labels b{color:#e8f3ff}

  .msg{padding:10px 12px; border-radius:10px; font-size:14px; display:none;}
  .ok{background:rgba(45,108,223,.14); border:1px solid rgba(45,108,223,.35)}
  .warn{background:rgba(239,68,68,.14); border:1px solid rgba(239,68,68,.35)}

  /* BIG vote buttons (fill their halves) */
  .row{
    display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:2px;
  }
  .vote{
    width:100%;
    border:0; border-radius:14px; padding:20px 16px;
    font-weight:1000; font-size:18px; cursor:pointer;
    transition:transform .08s ease, filter .18s ease; box-shadow:inset 0 -2px 0 rgba(0,0,0,.2)
  }
  .vote:hover{transform:translateY(-2px); filter:brightness(1.08)}
  .yes{background:var(--yes); color:#041307}
  .no{background:var(--no); color:#fff}

  /* EXPANDING INFO TEXT (1.5x size & bold; fills remaining space) */
  .info-wrap{flex:1 1 auto; min-height:0; display:flex;}
  .info-text{
    font-size:clamp(24px,2.4vw,30px); /* ~1.5x from earlier */
    font-weight:900;                   /* bold */
    color:#e9f2ff; line-height:1.45;
    background:rgba(255,255,255,.03);
    padding:16px; border-radius:10px; width:100%;
    outline:1px solid rgba(255,255,255,.06);
  }
  .info-text a{ color:#9cc7ff; text-underline-offset:2px; font-weight:900 }

  /* BIG suggestion buttons (blue & purple), full halves under the text */
  .row-cta{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .cta{
    width:100%; border:0; border-radius:14px; padding:18px 16px;
    font-weight:1000; font-size:17px; cursor:pointer; color:#041017;
    transition:transform .08s ease, filter .18s ease; box-shadow:inset 0 -2px 0 rgba(0,0,0,.2)
  }
  .cta:hover{ transform:translateY(-2px); filter:brightness(1.07) }
  .cta-blue{  background:linear-gradient(90deg,var(--blue1),var(--blue2)); color:#eaf6ff; }
  .cta-purple{background:linear-gradient(90deg,var(--vio1), var(--vio2));  color:#f3ecff; }

  /* RIGHT (image) */
  .right{
    position:relative; display:flex; align-items:center; justify-content:center;
    border-radius:12px; overflow:hidden; outline:1px solid rgba(255,255,255,.08);
    background:#0c1116; min-height:320px;
  }
  .shot{width:100%; height:100%; display:grid; place-items:center; padding:6px;}
  .shot img{width:100%; height:100%; object-fit:contain; display:block}
  .open-btn{
    position:absolute; top:10px; right:10px; padding:6px 10px; font-size:12px; font-weight:800;
    border-radius:10px; border:1px solid rgba(255,255,255,.32);
    background:rgba(6,12,18,.55); color:#e9f2ff; backdrop-filter: blur(6px);
    cursor:pointer;
  }

  @media(max-width:900px){
    .layout{grid-template-columns:1fr}
    .info-wrap{min-height:auto}
    .row, .row-cta{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="card" role="region" aria-labelledby="title">
  <div class="layout">
    <!-- LEFT -->
    <section class="left">
      <h1 id="title" class="title">Do you like this theme? (should we change to this)</h1>
      <p class="sub">One vote per device.</p>

      <section class="tally" aria-live="polite">
        <div class="t-head">
          <div class="t-title">Current rating</div>
          <div id="totals" class="t-numbers">‚Äî</div>
        </div>
        <div class="bar" role="img" aria-label="Live vote distribution by percent">
          <div id="barYes" class="bar-yes" style="width:0%"></div>
          <div id="barNo"  class="bar-no"  style="width:0%"></div>
        </div>
        <div class="labels">
          <span>Yes: <b id="pYes">‚Äî</b></span>
          <span>No: <b id="pNo">‚Äî</b></span>
        </div>
      </section>

      <div id="msg" class="msg ok" role="status" aria-live="polite"></div>

      <!-- BIG vote buttons -->
      <div class="row" aria-label="Vote on theme">
        <button id="yes" class="vote yes" type="button" aria-label="Vote Yes">üëç Yes</button>
        <button id="no"  class="vote no"  type="button" aria-label="Vote No">üëé No</button>
      </div>

      <!-- EXPANDING info text (bold, 1.5x size) -->
      <div class="info-wrap">
        <div class="info-text">
          What colors should the background be? What colors do you think would be best? 
          Fill out our <a href="https://docs.google.com/forms/d/e/1FAIpQLSfWkJmq5rk10-AETybm7hJPQ2M75gMGm2OWsbiS_XrqMI9l0g/viewform?usp=header" target="_blank" rel="noopener">Google Form</a> for a chance at a shout-out | 
          This won‚Äôt be the only redesign change, more coming soon!
        </div>
      </div>

      <!-- BIG suggestion buttons (blue & purple) -->
      <div class="row-cta">
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSfFiegPH6GsWIWERzfbtptJW2GMk4exkrTQsdqlR2-2oj83zA/viewform" target="_blank" rel="noopener">
          <button class="cta cta-blue" type="button" aria-label="Open form to suggest games">üí° Suggest Games</button>
        </a>
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSfWkJmq5rk10-AETybm7hJPQ2M75gMGm2OWsbiS_XrqMI9l0g/viewform?usp=header" target="_blank" rel="noopener">
          <button class="cta cta-purple" type="button" aria-label="Open form to suggest redesign ideas">üõ†Ô∏è Suggest Redesign Ideas</button>
        </a>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="right">
      <button id="openFull" class="open-btn" type="button" aria-label="Open full-size image in a new tab">üîç View Full</button>
      <figure class="shot">
        <img
          id="preview"
          src="https://res.cloudinary.com/dcsrqennd/image/upload/v1758837156/Screenshot_2025-09-25_145121_diuzmd.png"
          alt="Screenshot of the proposed Static931 theme with homepage layout, navigation, and hero"
          loading="eager" decoding="async"
        />
      </figure>
    </aside>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, doc, runTransaction, increment, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCFkdHG5na9uhLQwu65QTuOvELmA68MCKA",
    authDomain: "votingonredesign.firebaseapp.com",
    projectId: "votingonredesign",
    storageBucket: "votingonredesign.firebasestorage.app",
    messagingSenderId: "66146609429",
    appId: "1:66146609429:web:34575c54f0a3b78ce7611c",
    measurementId: "G-FL6RJVCN3Y"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // Open full-size
  const fullUrl = "https://res.cloudinary.com/dcsrqennd/image/upload/v1758837156/Screenshot_2025-09-25_145121_diuzmd.png";
  document.getElementById("openFull").addEventListener("click", () => window.open(fullUrl, "_blank", "noopener"));
  document.getElementById("preview").addEventListener("click",   () => window.open(fullUrl, "_blank", "noopener"));

  // UI refs
  const btnYes = document.getElementById("yes");
  const btnNo  = document.getElementById("no");
  const msg    = document.getElementById("msg");
  const totalsEl = document.getElementById("totals");
  const barYes = document.getElementById("barYes");
  const barNo  = document.getElementById("barNo");
  const pYes   = document.getElementById("pYes");
  const pNo    = document.getElementById("pNo");

  // Local device & per-poll keys (so prior polls don‚Äôt block this one)
  const DEVICE_KEY  = "qr_device_id";
  const PENDING_KEY = "qr_pending_vote_img_v7";
  const LOCK_KEY    = "qr_voted_choice_img_v7";

  // NEW poll id so it registers as another voting (aligned with your /polls rules)
  const POLL_ID = "design_screenshot_diuzmd_v7";

  // Firestore paths per your rules (single tally doc + votes subcollection)
  const tallyDoc = doc(db, "polls", POLL_ID);
  const voteDoc  = (deviceId) => doc(db, "polls", POLL_ID, "votes", deviceId);

  // Stable device id across polls
  const uuid = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
  const deviceId = (() => {
    let id = localStorage.getItem(DEVICE_KEY);
    if (!id){ id = uuid(); localStorage.setItem(DEVICE_KEY,id); }
    return id;
  })();

  function lock(choice, text){
    btnYes.disabled = true; btnNo.disabled = true;
    btnYes.style.opacity=".7"; btnNo.style.opacity=".7";
    msg.className = "msg ok"; msg.style.display="block";
    msg.textContent = text || `You already voted ‚Äú${choice.toUpperCase()}‚Äù.`;
  }
  function showWarn(text){
    msg.className = "msg warn"; msg.style.display="block"; msg.textContent = text;
  }

  // Ensure tally doc exists with {yes:0, no:0}
  (async () => {
    const snap = await getDoc(tallyDoc);
    if (!snap.exists()) await setDoc(tallyDoc, { yes: 0, no: 0 }); // matches your create rule
  })().catch(console.error);

  // Live percentage UI
  onSnapshot(tallyDoc, (snap) => {
    const data = snap.data() || { yes: 0, no: 0 };
    const yes = Math.max(0, data.yes|0);
    const no  = Math.max(0, data.no|0);
    const total = yes + no;
    const yPct = total ? Math.round((yes/total)*100) : 0;
    const nPct = total ? Math.round((no /total)*100) : 0;

    totalsEl.textContent = total ? `${yPct}% yes ¬∑ ${nPct}% no` : "No votes yet";
    barYes.style.width = yPct + "%";
    barNo .style.width = nPct + "%";
    pYes.textContent = total ? yPct + "%" : "‚Äî";
    pNo .textContent = total ? nPct + "%" : "‚Äî";
  }, (err) => {
    console.error("Snapshot error:", err);
    totalsEl.textContent = "Live results unavailable";
  });

  // Local lock for THIS poll only
  const already = localStorage.getItem(LOCK_KEY);
  if (already){ lock(already); }

  // Resume pending
  const pendingRaw = localStorage.getItem(PENDING_KEY);
  if (!already && pendingRaw){
    const { choice } = JSON.parse(pendingRaw);
    finalizeUpload(choice).then(()=>{
      localStorage.setItem(LOCK_KEY, choice);
      localStorage.removeItem(PENDING_KEY);
      lock(choice, `Thanks! Your ‚Äú${choice.toUpperCase()}‚Äù vote was recorded.`);
    }).catch(()=>showWarn("Reconnecting‚Ä¶ your vote will upload when possible."));
  }

  btnYes.addEventListener("click", () => handleVote("yes"));
  btnNo .addEventListener("click", () => handleVote("no"));

  async function handleVote(choice){
    if (localStorage.getItem(LOCK_KEY)) return;
    localStorage.setItem(PENDING_KEY, JSON.stringify({ choice, at: Date.now() }));
    msg.style.display = "block"; msg.className = "msg ok"; msg.textContent = "Saving your choice‚Ä¶";
    btnYes.disabled = true; btnNo.disabled = true;

    try {
      await finalizeUpload(choice);
      localStorage.setItem(LOCK_KEY, choice);
      localStorage.removeItem(PENDING_KEY);
      lock(choice, `Thanks! Your ‚Äú${choice.toUpperCase()}‚Äù vote was recorded.`);
    } catch (e){
      if (e.code === "permission-denied") {
        // Rules rejected (duplicate or blocked) ‚Äî treat as already voted for UX
        localStorage.setItem(LOCK_KEY, choice);
        lock(choice, "Looks like you already voted on this device.");
      } else {
        showWarn("Network issue ‚Äî your vote is saved locally and will upload when you return.");
      }
      console.error("Vote upload failed:", e);
    }
  }

  // Matches your rules: no reads on /votes/*; create once; increment exactly one counter
  async function finalizeUpload(choice){
    const vDoc = voteDoc(deviceId);
    await runTransaction(db, async (tx) => {
      tx.set(vDoc, { choice, deviceId, votedAt: new Date().toISOString() });
      tx.update(tallyDoc, { [choice]: increment(1) });
    });
  }

  // Guard
  window.onbeforeunload = function(){
    if (!localStorage.getItem(LOCK_KEY) && localStorage.getItem(PENDING_KEY)){
      return "Your vote is saved locally and uploading. Leave now?";
    }
  };
</script>

<!-- Copy/paste these Firestore Security Rules into Firebase Console (Rules tab).
     Including here for completeness as requested; this block is NOT executed by the page. -->
<script id="firestore-rules" type="text/plain">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /polls/{pollId} {
      allow read: if true;

      allow create: if
        request.resource.data.keys().hasOnly(['yes','no']) &&
        request.resource.data.yes == 0 &&
        request.resource.data.no == 0;

      allow update: if
        request.resource.data.keys().hasOnly(['yes','no']) &&
        resource.data.keys().hasOnly(['yes','no']) &&
        request.resource.data.yes >= resource.data.yes &&
        request.resource.data.no >= resource.data.no &&
        (
          (request.resource.data.yes - resource.data.yes == 1 &&
           request.resource.data.no  - resource.data.no  == 0) ||
          (request.resource.data.yes - resource.data.yes == 0 &&
           request.resource.data.no  - resource.data.no  == 1)
        );
      allow delete: if false;

      match /votes/{deviceId} {
        allow read: if false;
        allow create: if
          request.resource.data.keys().hasOnly(['choice','deviceId','votedAt']) &&
          request.resource.data.deviceId == deviceId &&
          !exists(/databases/$(database)/documents/polls/$(pollId)/votes/$(deviceId)) &&
          (request.resource.data.choice == 'yes' || request.resource.data.choice == 'no');
        allow update, delete: if false;
      }
    }
    match /{document=**} { allow read, write: if false; }
  }
}
</script>
</body>
</html>

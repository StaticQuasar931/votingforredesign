<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vote ‚Äì Site Redesign</title>
<style>
  body { font-family: sans-serif; background: #111; color: #eee; display: flex; justify-content: center; align-items: center; height: 100vh; }
  .vote-card { background: #1b1f24; padding: 20px; border-radius: 12px; text-align: center; width: 300px; }
  .vote-title { font-size: 18px; font-weight: bold; margin-bottom: 12px; }
  .btn-row { display: flex; gap: 10px; }
  button { flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
  .yes { background: #22c55e; color: #000; }
  .no { background: #ef4444; color: #fff; }
  .thanks { margin-top: 12px; font-size: 14px; color: #ccc; }
</style>
</head>
<body>
<div class="vote-card">
  <div class="vote-title">Should the site have a huge redesign?</div>
  <div class="btn-row">
    <button id="btnYes" class="yes">üëç Yes</button>
    <button id="btnNo" class="no">üëé No</button>
  </div>
  <div id="thanks" class="thanks" style="display:none;"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, doc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCFkdHG5na9uhLQwu65QTuOvELmA68MCKA",
    authDomain: "votingonredesign.firebaseapp.com",
    projectId: "votingonredesign",
    storageBucket: "votingonredesign.firebasestorage.app",
    messagingSenderId: "66146609429",
    appId: "1:66146609429:web:34575c54f0a3b78ce7611c",
    measurementId: "G-FL6RJVCN3Y"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const btnYes = document.getElementById("btnYes");
  const btnNo = document.getElementById("btnNo");
  const thanks = document.getElementById("thanks");

  const LS_KEY = "poll_site_redesign_voted";

  async function vote(choice) {
    if (localStorage.getItem(LS_KEY)) return;

    const pollRef = doc(db, "polls", "site_redesign");
    try {
      await setDoc(pollRef, { yes: 0, no: 0 }, { merge: true });
      await updateDoc(pollRef, { [choice]: increment(1) });

      localStorage.setItem(LS_KEY, choice);
      thanks.style.display = "block";
      thanks.textContent = `Thanks! You voted "${choice.toUpperCase()}".`;
      btnYes.disabled = true;
      btnNo.disabled = true;
    } catch (err) {
      console.error("Error voting:", err);
      thanks.style.display = "block";
      thanks.textContent = "Error recording vote.";
    }
  }

  btnYes.addEventListener("click", () => vote("yes"));
  btnNo.addEventListener("click", () => vote("no"));

  // Restore disabled state if already voted
  const prev = localStorage.getItem(LS_KEY);
  if (prev) {
    btnYes.disabled = true;
    btnNo.disabled = true;
    thanks.style.display = "block";
    thanks.textContent = `You already voted "${prev.toUpperCase()}".`;
  }

  // Warn before leaving if not voted
  window.onbeforeunload = function() {
    if (!localStorage.getItem(LS_KEY)) {
      return "Are you sure you want to leave? Your vote hasn't been submitted.";
    }
  };
</script>
</body>
</html>
